  - type: custom:mushroom-title-card
    title: Modes THX
    subtitle: Modes cinéma, musique et jeux THX
  - type: grid
    columns: 3
    square: false
    cards:
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Cinema
        icon: mdi:movie-open
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0101SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                // Vérifier par le nom
                var hasThx = modeLower.includes('thx');
                var hasCinema = modeLower.includes('cinema');
                var hasMusic = modeLower.includes('music');
                var nameMatch = hasThx && hasCinema && !hasMusic;
                // Vérifier aussi par le code (0101 = THX Cinema - code correct)
                var codeMatch = false;
                if (modeCode) {
                  var codeStr = String(modeCode).trim();
                  // Code correct pour THX Cinema: 0101
                  // Accepter aussi les anciens codes pour compatibilité
                  codeMatch = codeStr === '0101' ||  // Code correct
                             codeStr === '0056';     // Ancien code (mappé vers 0101)
                }
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #dc2626 0%, #991b1b 100%)"
                - box-shadow: 0 8px 16px rgba(220, 38, 38, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 13px
          icon:
            - color: white
            - width: 32px
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Music
        icon: mdi:music-circle
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0102SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                var hasThx = modeLower.includes('thx');
                var hasMusic = modeLower.includes('music');
                var hasCinema = modeLower.includes('cinema');
                var nameMatch = hasThx && hasMusic && !hasCinema;
                var codeMatch = modeCode && String(modeCode).trim() === '0102';
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #ec4899 0%, #db2777 100%)"
                - box-shadow: 0 8px 16px rgba(236, 72, 153, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 13px
          icon:
            - color: white
            - width: 32px
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Games
        icon: mdi:gamepad
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0103SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                var hasThx = modeLower.includes('thx');
                var hasGames = modeLower.includes('games');
                var nameMatch = hasThx && hasGames;
                var codeMatch = modeCode && String(modeCode).trim() === '0103';
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #f97316 0%, #ea580c 100%)"
                - box-shadow: 0 8px 16px rgba(249, 115, 22, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 13px
          icon:
            - color: white
            - width: 32px
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Select2 Cinema
        icon: mdi:movie-open-star
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0105SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                var hasThx = modeLower.includes('thx');
                var hasSelect2 = modeLower.includes('select2') || modeLower.includes('ultra2');
                var hasCinema = modeLower.includes('cinema');
                var hasMusic = modeLower.includes('music');
                var hasGames = modeLower.includes('games');
                var nameMatch = hasThx && hasSelect2 && hasCinema && !hasMusic && !hasGames;
                var codeMatch = modeCode && (String(modeCode).trim() === '0105');
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #be123c 0%, #9f1239 100%)"
                - box-shadow: 0 8px 16px rgba(190, 18, 60, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 11px
          icon:
            - color: white
            - width: 32px
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Select2 Music
        icon: mdi:music-note-eighth
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0106SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                var hasThx = modeLower.includes('thx');
                var hasSelect2 = modeLower.includes('select2') || modeLower.includes('ultra2');
                var hasMusic = modeLower.includes('music');
                var hasCinema = modeLower.includes('cinema');
                var hasGames = modeLower.includes('games');
                var nameMatch = hasThx && hasSelect2 && hasMusic && !hasCinema && !hasGames;
                var codeMatch = modeCode && (String(modeCode).trim() === '0106');
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #c026d3 0%, #a21caf 100%)"
                - box-shadow: 0 8px 16px rgba(192, 38, 211, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 11px
          icon:
            - color: white
            - width: 32px
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Select2 Games
        icon: mdi:gamepad-circle
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0107SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                var hasThx = modeLower.includes('thx');
                var hasSelect2 = modeLower.includes('select2') || modeLower.includes('ultra2');
                var hasGames = modeLower.includes('games');
                var hasCinema = modeLower.includes('cinema');
                var hasMusic = modeLower.includes('music');
                var nameMatch = hasThx && hasSelect2 && hasGames && !hasCinema && !hasMusic;
                var codeMatch = modeCode && (String(modeCode).trim() === '0107');
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #f97316 0%, #ea580c 100%)"
                - box-shadow: 0 8px 16px rgba(249, 115, 22, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 11px
          icon:
            - color: white
            - width: 32px
      - type: custom:button-card
        entity: media_player.pioneer_avr
        name: THX Surround EX
        icon: mdi:surround-sound-7-1
        tap_action:
          action: call-service
          service: pioneer_avr_lx83.send_raw_command
          service_data:
            entity_id: media_player.pioneer_avr
            command: 0115SR
        state:
          - operator: template
            value: |
              [[[
                var mode = states['media_player.pioneer_avr'].attributes.sound_mode;
                var modeCode = states['media_player.pioneer_avr'].attributes.sound_mode_code;
                if (!mode && !modeCode) return false;
                var modeLower = mode ? mode.toLowerCase().trim() : '';
                var hasThx = modeLower.includes('thx');
                var hasSurroundEx = modeLower.includes('surround ex') || modeLower.includes('surroundex') || modeLower.includes('surround ex');
                var nameMatch = hasThx && hasSurroundEx;
                var codeMatch = modeCode && (String(modeCode).trim() === '0115');
                return nameMatch || codeMatch;
              ]]]
            styles:
              card:
                - background: "linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)"
                - box-shadow: 0 8px 16px rgba(220, 38, 38, 0.4)
                - transform: scale(1.05)
        styles:
          card:
            - background: "linear-gradient(135deg, #475569 0%, #334155 100%)"
            - border-radius: 20px
            - transition: all 0.3s ease
          name:
            - color: white
            - font-weight: bold
            - font-size: 12px
          icon:
            - color: white
            - width: 32px